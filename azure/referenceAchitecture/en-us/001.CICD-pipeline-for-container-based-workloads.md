# Describe this pattern
reference : https://docs.microsoft.com/en-us/azure/architecture/example-scenario/apps/devops-with-aks
<br></br>
<img src="https://docs.microsoft.com/en-us/azure/architecture/example-scenario/apps/media/architecture-devops-with-aks.png"></img>

## Feature
- In order to know details about this architecture, click above URL.

# Implement
## 1. Make resource from predefined template.
- Right click the Link: [Click Here](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Fsolution-architectures%2Fmaster%2Fapps%2Fdevops-with-aks%2Fazuredeploy.json), and open in the new tab.

- Login to Azure, then you can see <b>Custom deployment</b> in azure portal.

- Click azure cloud shell button on the top of the web page.

- After loading Azure Cloud Shell, Type <code>az ad sp create-for-rbac --name myDevOpsScenario</code>
<br></br> ※ If it says you don't have sufficiant privilige, ask your owner of subscription to give you <b>Owner</b> role or custom role that has <b>Microsoft.Authorization/roleAssignments/write</b>. Every predefined role don't have that permition. (reference : https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles )
<img src="../img/001.spinfo.png"></img>
- Make SSH Key : Type <code>ssh-keygen -t rsa -b 2048</code> on your cloud shell. Terminal may ask you key name and passphrase. Just type <b>Enter</b> key.

- Find the supported Kubernetes versions for your deployment region : <code>az aks get-versions -l <region> --query "orchestrators[?default!=null].orchestratorVersion" -o tsv</code>
  
- From now, you can fill on the blanks.  
<img src="../img/001.deploymain.png"></img>
  1. Sp Clint Id : "appId" of previous step
  2. Sp Clint Secret : ""password" of previous step
  3. Linux Admin Username & Password : Now, you should define.
  4. Linux SSH Public Key : We already make it in previous step. Type the command on cloud shell <code>cat ~/.ssh/id_rsa.pub</code>
  5. Kubernetes Version : Type as you know.

- Waiting for 20-30 minute.

## 2. Enter Jenkins Web Server
- Click Jenkins server on your resource tab in azure portal. And copy public IP Address of jenkins server.
- Type http://(public ip address) on your browser. Than you can see the page like below.
<img src="../img/001.jenkins_default.png"></img>
> You need to use ssh cli command. When you use linux or MAC environment, you just type command <code>ssh -L 127.0.0.1:8080:localhost:8080 (your username)@jenkinsg.......</code> sign in your browser. If you use windows environment, you need to install 3th-party ssh tool.
- In the lab, I'm going to use git bash to establish ssh connection.
  > Open git bash terminal - type <code>ssh -L 127.0.0.1:8080:localhost:8080 (your username)@jenkinsg.......</code>
- Now you can connect web console page through forwarded local port. Type http://localhost:8080 on your browser.
  <img src="../img/unlock_jenkins.png"></img>
- Then, you will see below page. To unlock jenkins server, Connect to jenkins server on azure cloud shell. <code>ssh (yourID)@(Jenkins Public IP)</code>. Because you generate ssh key in yuor cloud shell environment, you don't have to type your password. In order to get password for unlocking jenkins web console, type <code>sudo cat /var/lib/jenkins/secrets/initialAdminPassword</code>
  ※ Reference : https://docs.microsoft.com/ko-kr/azure/jenkins/install-jenkins-solution-template
- Create initial admin account and Install suggested plugins. Now, you can see Jenkins Dashboard.
- In main page of jenkins console, click <b>Hello World Build & Deploy</b> link. Then you can see deployed pipeline.
  <img src=""><img>
